{"ast":null,"code":"import _regeneratorRuntime from\"/Users/tristanwhite/IdeaProjects/jbook/packages/local-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/tristanwhite/IdeaProjects/jbook/packages/local-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import axios from\"axios\";import localForage from'localforage';var fileCache=localForage.createInstance({name:'filecache'});export var fetchPlugin=function fetchPlugin(input){return{name:'fetch-plugin',setup:function setup(build){build.onLoad({filter:/(^index\\.js$)/},function(){return{loader:'jsx',contents:input};});build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(args){var cachedResult;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context.sent;if(!cachedResult){_context.next=5;break;}return _context.abrupt(\"return\",cachedResult);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());build.onLoad({filter:/.css$/},/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(args){var _yield$axios$get,data,request,escaped,contents,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.get(args.path);case 2:_yield$axios$get=_context2.sent;data=_yield$axios$get.data;request=_yield$axios$get.request;// args.path = key\nescaped=data.replace(/\\n/g,'').replace(/\"/g,'\\\\\"').replace(/'/g,\"\\\\'\");contents=\"\\n                            const style = document.createElement('style');\\n                            style.innerText = '\".concat(escaped,\"';\\n                            document.head.appendChild(style);\\n                        \");result={loader:'jsx',contents:contents,resolveDir:new URL('./',request.responseURL).pathname};//store responce in cache\n_context2.next=10;return fileCache.setItem(args.path,result);case 10:return _context2.abrupt(\"return\",result);case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(args){var _yield$axios$get2,data,request,result;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return axios.get(args.path);case 2:_yield$axios$get2=_context3.sent;data=_yield$axios$get2.data;request=_yield$axios$get2.request;// args.path = key\nresult={loader:'jsx',contents:data,resolveDir:new URL('./',request.responseURL).pathname};//store responce in cache\n_context3.next=8;return fileCache.setItem(args.path,result);case 8:return _context3.abrupt(\"return\",result);case 9:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}());}};};","map":{"version":3,"sources":["/Users/tristanwhite/IdeaProjects/jbook/packages/local-client/src/bundler/plugins/fetch-plugin.ts"],"names":["axios","localForage","fileCache","createInstance","name","fetchPlugin","input","setup","build","onLoad","filter","loader","contents","args","getItem","path","cachedResult","get","data","request","escaped","replace","result","resolveDir","URL","responseURL","pathname","setItem"],"mappings":"mWACA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CACA,MAAOC,CAAAA,WAAP,KAAwB,aAAxB,CAEA,GAAMC,CAAAA,SAAS,CAAGD,WAAW,CAACE,cAAZ,CAA2B,CACzCC,IAAI,CAAE,WADmC,CAA3B,CAAlB,CAKA,MAAO,IAAMC,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAACC,KAAD,CAAmB,CAC1C,MAAM,CACFF,IAAI,CAAE,cADJ,CAEFG,KAFE,gBAEIC,KAFJ,CAEgC,CAC9BA,KAAK,CAACC,MAAN,CAAa,CAACC,MAAM,CAAE,eAAT,CAAb,CAAwC,UAAK,CACzC,MAAO,CACHC,MAAM,CAAE,KADL,CAEHC,QAAQ,CAAEN,KAFP,CAAP,CAIH,CALD,EAOAE,KAAK,CAACC,MAAN,CAAa,CAACC,MAAM,CAAE,IAAT,CAAb,0FAA6B,iBAAOG,IAAP,yJAEEX,CAAAA,SAAS,CAACY,OAAV,CAAwCD,IAAI,CAACE,IAA7C,CAFF,QAEnBC,YAFmB,mBAKrBA,YALqB,yDAMdA,YANc,wDAA7B,gEAUAR,KAAK,CAACC,MAAN,CAAa,CAACC,MAAM,CAAE,OAAT,CAAb,2FAAgC,kBAAOG,IAAP,uMAEGb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CAFH,wCAEpBG,IAFoB,kBAEpBA,IAFoB,CAEdC,OAFc,kBAEdA,OAFc,CAG5B;AAEMC,OALsB,CAKZF,IAAI,CACfG,OADW,CACH,KADG,CACI,EADJ,EAEXA,OAFW,CAEH,IAFG,CAEG,KAFH,EAGXA,OAHW,CAGH,IAHG,CAGG,KAHH,CALY,CAUtBT,QAVsB,wIAaKQ,OAbL,gGAiBtBE,MAjBsB,CAiBS,CACjCX,MAAM,CAAE,KADyB,CAEjCC,QAAQ,CAARA,QAFiC,CAGjCW,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHd,CAjBT,CAsB5B;AAtB4B,wBAuBtBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CAvBsB,0CAyBrBA,MAzBqB,2DAAhC,kEA6BAd,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,2FAA+B,kBAAOG,IAAP,uLAEIb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CAFJ,yCAEnBG,IAFmB,mBAEnBA,IAFmB,CAEbC,OAFa,mBAEbA,OAFa,CAG3B;AAEMG,MALqB,CAKU,CACjCX,MAAM,CAAE,KADyB,CAEjCC,QAAQ,CAAEM,IAFuB,CAGjCK,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHd,CALV,CAU3B;AAV2B,uBAWrBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CAXqB,yCAapBA,MAboB,0DAA/B,kEAgBH,CAjEC,CAAN,CAmEH,CApEM","sourcesContent":["import * as esbuild from \"esbuild-wasm\";\nimport axios from \"axios\";\nimport localForage from 'localforage';\n\nconst fileCache = localForage.createInstance({\n    name: 'filecache'\n});\n\n\nexport const fetchPlugin = (input: string) => {\n    return{\n        name: 'fetch-plugin',\n        setup(build: esbuild.PluginBuild) {\n            build.onLoad({filter: /(^index\\.js$)/}, ()=> {\n                return {\n                    loader: 'jsx',\n                    contents: input,\n                };\n            });\n\n            build.onLoad({filter: /.*/}, async (args: any) =>{\n                //check to see if we have already fetched this file\n                const cachedResult = await fileCache.getItem<esbuild.OnLoadResult>(args.path);\n\n                //and if it is, return immediately\n                if (cachedResult) {\n                    return cachedResult;\n                }\n            });\n\n            build.onLoad({filter: /.css$/}, async (args: any) => {\n\n                const { data, request} = await axios.get(args.path);\n                // args.path = key\n\n                const escaped = data\n                    .replace(/\\n/g, '')\n                    .replace(/\"/g, '\\\\\"')\n                    .replace(/'/g, \"\\\\'\");\n\n                const contents =\n                        `\n                            const style = document.createElement('style');\n                            style.innerText = '${escaped}';\n                            document.head.appendChild(style);\n                        `;\n\n                const result: esbuild.OnLoadResult = {\n                    loader: 'jsx',\n                    contents,\n                    resolveDir: new URL('./', request.responseURL).pathname\n                }\n                //store responce in cache\n                await fileCache.setItem(args.path, result);\n\n                return result;\n                //vales stored\n            });\n\n            build.onLoad({ filter: /.*/ }, async (args: any) => {\n\n                const { data, request} = await axios.get(args.path);\n                // args.path = key\n\n                const result: esbuild.OnLoadResult = {\n                    loader: 'jsx',\n                    contents: data,\n                    resolveDir: new URL('./', request.responseURL).pathname\n                }\n                //store responce in cache\n                await fileCache.setItem(args.path, result);\n\n                return result;\n                //vales stored\n            });\n        }\n    }\n}\n"]},"metadata":{},"sourceType":"module"}